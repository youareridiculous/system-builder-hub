<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ›’ Marketplace - System Builder Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .back-to-dashboard {
            color: white;
            text-decoration: none;
            font-weight: 500;
        }
        
        .back-to-dashboard:hover {
            color: #f8f9fa;
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .search-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .search-input {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover, .filter-btn.active {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: translateY(-2px);
        }
        
        .listing-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .listing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .listing-title {
            color: white;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .listing-description {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .listing-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .listing-price {
            color: #4CAF50;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .listing-rating {
            color: #FFD700;
            font-size: 1rem;
        }
        
        .listing-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
        
        .listing-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tag {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        .purchase-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .purchase-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .featured-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 2rem;
        }
        
        .page-link {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            margin: 0 0.25rem;
        }
        
        .page-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .page-item.active .page-link {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
        }
        
        .btn-close {
            filter: invert(1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-shopping-cart me-2"></i>System Builder Hub
            </a>
            <a href="/" class="back-to-dashboard">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white text-center mb-3">
                        <i class="fas fa-shopping-cart me-3"></i>Marketplace
                    </h1>
                    <p class="text-white text-center opacity-75">
                        Discover, purchase, and monetize agents, systems, and templates
                    </p>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-listings">0</div>
                        <div class="metric-label">Total Listings</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-downloads">0</div>
                        <div class="metric-label">Total Downloads</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-revenue">$0</div>
                        <div class="metric-label">Total Revenue</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="featured-count">0</div>
                        <div class="metric-label">Featured Items</div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="search-section">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" class="form-control search-input" id="search-input" 
                               placeholder="Search for agents, systems, templates...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchListings()">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-white mb-2">Filter by Type:</h6>
                        <button class="filter-btn active" data-type="all">All</button>
                        <button class="filter-btn" data-type="agent">Agents</button>
                        <button class="filter-btn" data-type="system">Systems</button>
                        <button class="filter-btn" data-type="template">Templates</button>
                        <button class="filter-btn" data-type="workflow">Workflows</button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-white mb-2">Filter by Price:</h6>
                        <button class="filter-btn" data-price="free">Free</button>
                        <button class="filter-btn" data-price="0-50">$0 - $50</button>
                        <button class="filter-btn" data-price="50-200">$50 - $200</button>
                        <button class="filter-btn" data-price="200+">$200+</button>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-white mb-2">Sort by:</h6>
                        <button class="filter-btn active" data-sort="featured">Featured</button>
                        <button class="filter-btn" data-sort="rating">Rating</button>
                        <button class="filter-btn" data-sort="downloads">Downloads</button>
                        <button class="filter-btn" data-sort="newest">Newest</button>
                        <button class="filter-btn" data-sort="price-low">Price: Low to High</button>
                        <button class="filter-btn" data-sort="price-high">Price: High to Low</button>
                    </div>
                </div>
            </div>

            <!-- Listings Grid -->
            <div class="row" id="listings-grid">
                <!-- Listings will be loaded here -->
            </div>

            <!-- Pagination -->
            <nav aria-label="Marketplace pagination">
                <ul class="pagination" id="pagination">
                    <!-- Pagination will be generated here -->
                </ul>
            </nav>
        </div>
    </div>

    <!-- Listing Detail Modal -->
    <div class="modal fade" id="listingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Listing Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Listing details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="purchase-modal-btn">Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
    <div class="modal fade" id="purchaseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Referral Code (Optional)</label>
                        <input type="text" class="form-control" id="referral-code" placeholder="Enter referral code">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Organization</label>
                        <select class="form-select" id="purchase-org">
                            <option value="default">Default Organization</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>Purchase Summary:</strong>
                        <div id="purchase-summary"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="completePurchase()">Complete Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentListings = [];
        let currentFilters = {
            type: 'all',
            price: 'all',
            sort: 'featured',
            search: ''
        };
        let currentPage = 1;
        let selectedListing = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadMarketplaceStats();
            loadListings();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn[data-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-type]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.type = this.dataset.type;
                    currentPage = 1;
                    loadListings();
                });
            });

            document.querySelectorAll('.filter-btn[data-price]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-price]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.price = this.dataset.price;
                    currentPage = 1;
                    loadListings();
                });
            });

            document.querySelectorAll('.filter-btn[data-sort]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn[data-sort]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilters.sort = this.dataset.sort;
                    currentPage = 1;
                    loadListings();
                });
            });

            // Search input
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchListings();
                }
            });
        }

        function loadMarketplaceStats() {
            fetch('/api/marketplace/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-listings').textContent = data.total_listings || 0;
                    document.getElementById('total-downloads').textContent = data.total_downloads || 0;
                    document.getElementById('total-revenue').textContent = `$${(data.total_revenue || 0).toFixed(2)}`;
                    document.getElementById('featured-count').textContent = data.featured_count || 0;
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        function loadListings() {
            const params = new URLSearchParams({
                page: currentPage,
                limit: 12,
                ...currentFilters
            });

            fetch(`/api/marketplace/listings?${params}`)
                .then(response => response.json())
                .then(data => {
                    currentListings = data.listings || [];
                    renderListings();
                    renderPagination(data.total || 0, data.pages || 1);
                })
                .catch(error => console.error('Error loading listings:', error));
        }

        function renderListings() {
            const grid = document.getElementById('listings-grid');
            grid.innerHTML = '';

            if (currentListings.length === 0) {
                grid.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="text-white">
                            <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
                            <h4>No listings found</h4>
                            <p>Try adjusting your search criteria or filters.</p>
                        </div>
                    </div>
                `;
                return;
            }

            currentListings.forEach(listing => {
                const card = createListingCard(listing);
                grid.appendChild(card);
            });
        }

        function createListingCard(listing) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            
            const priceText = listing.pricing_model === 'free' ? 'Free' : `$${listing.price}`;
            const ratingStars = 'â˜…'.repeat(Math.floor(listing.rating)) + 'â˜†'.repeat(5 - Math.floor(listing.rating));
            
            col.innerHTML = `
                <div class="listing-card position-relative" onclick="showListingDetails('${listing.listing_id}')">
                    ${listing.featured ? '<span class="featured-badge">Featured</span>' : ''}
                    <div class="listing-title">${listing.title}</div>
                    <div class="listing-description">${listing.description.substring(0, 100)}${listing.description.length > 100 ? '...' : ''}</div>
                    
                    <div class="listing-meta">
                        <div class="listing-price">${priceText}</div>
                        <div class="listing-rating">${ratingStars} (${listing.rating.toFixed(1)})</div>
                    </div>
                    
                    <div class="listing-stats">
                        <div class="stat-item">
                            <i class="fas fa-download me-1"></i>${listing.downloads}
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-comment me-1"></i>${listing.review_count}
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-tag me-1"></i>${listing.listing_type}
                        </div>
                    </div>
                    
                    <div class="listing-tags">
                        ${listing.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('')}
                    </div>
                    
                    <button class="purchase-btn" onclick="event.stopPropagation(); initiatePurchase('${listing.listing_id}')">
                        ${listing.pricing_model === 'free' ? 'Get Free' : 'Purchase'}
                    </button>
                </div>
            `;
            
            return col;
        }

        function renderPagination(total, pages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (pages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= pages; i++) {
                if (i === 1 || i === pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const li = document.createElement('li');
                    li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                    pagination.appendChild(li);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const li = document.createElement('li');
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(li);
                }
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === pages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            currentPage = page;
            loadListings();
        }

        function searchListings() {
            currentFilters.search = document.getElementById('search-input').value;
            currentPage = 1;
            loadListings();
        }

        function showListingDetails(listingId) {
            const listing = currentListings.find(l => l.listing_id === listingId);
            if (!listing) return;

            selectedListing = listing;
            
            document.getElementById('modal-title').textContent = listing.title;
            
            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Description</h6>
                        <p>${listing.description}</p>
                        
                        <h6>Features</h6>
                        <ul>
                            ${listing.features.map(feature => `<li>${feature}</li>`).join('')}
                        </ul>
                        
                        <h6>Use Cases</h6>
                        <ul>
                            ${listing.use_cases.map(useCase => `<li>${useCase}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6>Details</h6>
                                <p><strong>Type:</strong> ${listing.listing_type}</p>
                                <p><strong>Version:</strong> ${listing.version}</p>
                                <p><strong>Downloads:</strong> ${listing.downloads}</p>
                                <p><strong>Rating:</strong> ${listing.rating.toFixed(1)}/5 (${listing.review_count} reviews)</p>
                                <p><strong>License:</strong> ${listing.license_type}</p>
                                
                                <h6 class="mt-3">Tags</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    ${listing.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('listingModal'));
            modal.show();
        }

        function initiatePurchase(listingId) {
            const listing = currentListings.find(l => l.listing_id === listingId);
            if (!listing) return;

            selectedListing = listing;
            
            // Update purchase summary
            const priceText = listing.pricing_model === 'free' ? 'Free' : `$${listing.price}`;
            document.getElementById('purchase-summary').innerHTML = `
                <p><strong>Item:</strong> ${listing.title}</p>
                <p><strong>Price:</strong> ${priceText}</p>
                <p><strong>Type:</strong> ${listing.listing_type}</p>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
            modal.show();
        }

        function completePurchase() {
            if (!selectedListing) return;

            const referralCode = document.getElementById('referral-code').value;
            const organizationId = document.getElementById('purchase-org').value;

            const purchaseData = {
                listing_id: selectedListing.listing_id,
                buyer_id: 'current_user', // This would come from session
                buyer_organization_id: organizationId,
                referral_code: referralCode || null
            };

            fetch('/api/marketplace/purchase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(purchaseData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.purchase_id) {
                    alert('Purchase completed successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide();
                    loadMarketplaceStats(); // Refresh stats
                } else {
                    alert('Purchase failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Purchase error:', error);
                alert('Purchase failed. Please try again.');
            });
        }
    </script>
</body>
</html>
