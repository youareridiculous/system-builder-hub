<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Access Control - System Builder Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1.5rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            border: none;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .badge {
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 25px;
            margin-right: 0.5rem;
            padding: 0.75rem 1.5rem;
            color: #666;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .back-to-dashboard {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .back-to-dashboard:hover {
            color: #f8f9fa;
            transform: translateX(-5px);
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .status-active { background-color: #28a745; }
        .status-pending { background-color: #ffc107; }
        .status-expired { background-color: #dc3545; }
        
        .access-level-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .access-public { background-color: #d4edda; color: #155724; }
        .access-private { background-color: #f8d7da; color: #721c24; }
        .access-unlisted { background-color: #fff3cd; color: #856404; }
        .access-restricted { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-shield-alt me-2"></i>System Builder Hub
            </a>
            <a href="/" class="back-to-dashboard">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white text-center mb-3">
                        <i class="fas fa-shield-alt me-3"></i>Access Control
                    </h1>
                    <p class="text-white text-center opacity-75">
                        Fine-grained access control for systems, agents, and resources
                    </p>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-systems">0</div>
                        <div class="metric-label">Protected Systems</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="active-users">0</div>
                        <div class="metric-label">Active Users</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="pending-invites">0</div>
                        <div class="metric-label">Pending Invites</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="access-attempts">0</div>
                        <div class="metric-label">Access Attempts (24h)</div>
                    </div>
                </div>
            </div>

            <!-- Main Content Tabs -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs" id="accessControlTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="systems-tab" data-bs-toggle="tab" data-bs-target="#systems" type="button" role="tab">
                                <i class="fas fa-server me-2"></i>System Access
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>User Roles
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invites-tab" data-bs-toggle="tab" data-bs-target="#invites" type="button" role="tab">
                                <i class="fas fa-envelope me-2"></i>Invites
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sharing-tab" data-bs-toggle="tab" data-bs-target="#sharing" type="button" role="tab">
                                <i class="fas fa-link me-2"></i>Share Links
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
                                <i class="fas fa-list-alt me-2"></i>Access Logs
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body">
                    <div class="tab-content" id="accessControlTabContent">
                        <!-- System Access Tab -->
                        <div class="tab-pane fade show active" id="systems" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>System Access Settings</h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSystemModal">
                                        <i class="fas fa-plus me-2"></i>Add System
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>System ID</th>
                                            <th>Access Level</th>
                                            <th>Owner</th>
                                            <th>Users</th>
                                            <th>Restrictions</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="systemsTableBody">
                                        <!-- Systems will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- User Roles Tab -->
                        <div class="tab-pane fade" id="roles" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>User Role Management</h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignRoleModal">
                                        <i class="fas fa-user-plus me-2"></i>Assign Role
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>System</th>
                                            <th>Role</th>
                                            <th>Granted By</th>
                                            <th>Expires</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rolesTableBody">
                                        <!-- Roles will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Invites Tab -->
                        <div class="tab-pane fade" id="invites" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>Access Invitations</h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createInviteModal">
                                        <i class="fas fa-paper-plane me-2"></i>Send Invite
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>System</th>
                                            <th>Role</th>
                                            <th>Sent By</th>
                                            <th>Expires</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invitesTableBody">
                                        <!-- Invites will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Share Links Tab -->
                        <div class="tab-pane fade" id="sharing" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>Shareable Links</h5>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createShareLinkModal">
                                        <i class="fas fa-share-alt me-2"></i>Create Link
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Link ID</th>
                                            <th>System</th>
                                            <th>Access Level</th>
                                            <th>Created By</th>
                                            <th>Uses</th>
                                            <th>Expires</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shareLinksTableBody">
                                        <!-- Share links will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Access Logs Tab -->
                        <div class="tab-pane fade" id="logs" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h5>Access Attempt Logs</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="logSearchInput" placeholder="Search logs...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchLogs()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>User</th>
                                            <th>System</th>
                                            <th>IP Address</th>
                                            <th>Trigger</th>
                                            <th>Success</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logsTableBody">
                                        <!-- Logs will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Add System Modal -->
    <div class="modal fade" id="addSystemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add System Access Control</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSystemForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">System ID</label>
                                    <input type="text" class="form-control" id="systemId" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Owner ID</label>
                                    <input type="text" class="form-control" id="ownerId" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Organization ID</label>
                                    <input type="text" class="form-control" id="organizationId" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Access Level</label>
                                    <select class="form-select" id="accessLevel" required>
                                        <option value="private">Private</option>
                                        <option value="public">Public</option>
                                        <option value="unlisted">Unlisted</option>
                                        <option value="restricted">Restricted</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Allow Sharing</label>
                                    <select class="form-select" id="allowSharing">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Requires License</label>
                                    <select class="form-select" id="requiresLicense">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSystem()">Add System</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Role Modal -->
    <div class="modal fade" id="assignRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign User Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assignRoleForm">
                        <div class="mb-3">
                            <label class="form-label">System ID</label>
                            <input type="text" class="form-control" id="roleSystemId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">User ID</label>
                            <input type="text" class="form-control" id="roleUserId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Organization ID</label>
                            <input type="text" class="form-control" id="roleOrganizationId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role Type</label>
                            <select class="form-select" id="roleType" required>
                                <option value="viewer">Viewer</option>
                                <option value="editor">Editor</option>
                                <option value="admin">Admin</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Granted By</label>
                            <input type="text" class="form-control" id="grantedBy" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignRole()">Assign Role</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Invite Modal -->
    <div class="modal fade" id="createInviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Access Invitation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createInviteForm">
                        <div class="mb-3">
                            <label class="form-label">System ID</label>
                            <input type="text" class="form-control" id="inviteSystemId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="inviteEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role Type</label>
                            <select class="form-select" id="inviteRoleType" required>
                                <option value="viewer">Viewer</option>
                                <option value="editor">Editor</option>
                                <option value="admin">Admin</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Invited By</label>
                            <input type="text" class="form-control" id="invitedBy" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message (Optional)</label>
                            <textarea class="form-control" id="inviteMessage" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createInvite()">Send Invite</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Share Link Modal -->
    <div class="modal fade" id="createShareLinkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Shareable Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createShareLinkForm">
                        <div class="mb-3">
                            <label class="form-label">System ID</label>
                            <input type="text" class="form-control" id="shareSystemId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Access Level</label>
                            <select class="form-select" id="shareAccessLevel" required>
                                <option value="view">View Only</option>
                                <option value="edit">Edit</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Created By</label>
                            <input type="text" class="form-control" id="shareCreatedBy" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expires In (Days)</label>
                            <input type="number" class="form-control" id="shareExpiresIn" min="1" max="365">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Uses</label>
                            <input type="number" class="form-control" id="shareMaxUses" min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password (Optional)</label>
                            <input type="password" class="form-control" id="sharePassword">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createShareLink()">Create Link</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentSystemId = null;
        let currentTab = 'systems';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadMetrics();
            loadSystems();
            loadRoles();
            loadInvites();
            loadShareLinks();
            loadLogs();
        });

        // Load metrics
        async function loadMetrics() {
            try {
                const response = await fetch('/api/access-control/metrics');
                const data = await response.json();
                
                document.getElementById('total-systems').textContent = data.total_systems || 0;
                document.getElementById('active-users').textContent = data.active_users || 0;
                document.getElementById('pending-invites').textContent = data.pending_invites || 0;
                document.getElementById('access-attempts').textContent = data.access_attempts_24h || 0;
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Load systems
        async function loadSystems() {
            try {
                const response = await fetch('/api/access-control/systems');
                const systems = await response.json();
                
                const tbody = document.getElementById('systemsTableBody');
                tbody.innerHTML = '';
                
                systems.forEach(system => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${system.system_id}</td>
                        <td><span class="badge access-${system.access_level}">${system.access_level}</span></td>
                        <td>${system.owner_id}</td>
                        <td>${Object.keys(system.roles).length} users</td>
                        <td>${system.ip_whitelist.length > 0 ? 'IP Restricted' : 'None'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editSystem('${system.system_id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSystem('${system.system_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading systems:', error);
            }
        }

        // Load roles
        async function loadRoles() {
            try {
                const response = await fetch('/api/access-control/roles');
                const roles = await response.json();
                
                const tbody = document.getElementById('rolesTableBody');
                tbody.innerHTML = '';
                
                roles.forEach(role => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${role.user_id}</td>
                        <td>${role.system_id}</td>
                        <td><span class="badge bg-primary">${role.role_type}</span></td>
                        <td>${role.granted_by}</td>
                        <td>${role.expires_at || 'Never'}</td>
                        <td>
                            <span class="status-indicator status-${role.is_active ? 'active' : 'expired'}"></span>
                            ${role.is_active ? 'Active' : 'Expired'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="revokeRole('${role.user_id}', '${role.system_id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        // Load invites
        async function loadInvites() {
            try {
                const response = await fetch('/api/access-control/invites');
                const invites = await response.json();
                
                const tbody = document.getElementById('invitesTableBody');
                tbody.innerHTML = '';
                
                invites.forEach(invite => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invite.invited_email}</td>
                        <td>${invite.system_id}</td>
                        <td><span class="badge bg-info">${invite.role_type}</span></td>
                        <td>${invite.invited_by}</td>
                        <td>${new Date(invite.expires_at).toLocaleDateString()}</td>
                        <td>
                            <span class="status-indicator status-${invite.status}"></span>
                            ${invite.status}
                        </td>
                        <td>
                            ${invite.status === 'pending' ? `
                                <button class="btn btn-sm btn-outline-success" onclick="resendInvite('${invite.invite_id}')">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelInvite('${invite.invite_id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading invites:', error);
            }
        }

        // Load share links
        async function loadShareLinks() {
            try {
                const response = await fetch('/api/access-control/share-links');
                const links = await response.json();
                
                const tbody = document.getElementById('shareLinksTableBody');
                tbody.innerHTML = '';
                
                links.forEach(link => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${link.link_id.substring(0, 8)}...</td>
                        <td>${link.system_id}</td>
                        <td><span class="badge bg-secondary">${link.access_level}</span></td>
                        <td>${link.created_by}</td>
                        <td>${link.current_uses}/${link.max_uses || '‚àû'}</td>
                        <td>${link.expires_at ? new Date(link.expires_at).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <span class="status-indicator status-${link.is_active ? 'active' : 'expired'}"></span>
                            ${link.is_active ? 'Active' : 'Inactive'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="copyLink('${link.link_id}')">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLink('${link.link_id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading share links:', error);
            }
        }

        // Load logs
        async function loadLogs() {
            try {
                const response = await fetch('/api/access-control/logs');
                const logs = await response.json();
                
                const tbody = document.getElementById('logsTableBody');
                tbody.innerHTML = '';
                
                logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>${log.user_id || 'Anonymous'}</td>
                        <td>${log.system_id}</td>
                        <td>${log.ip_address}</td>
                        <td><span class="badge bg-secondary">${log.access_trigger}</span></td>
                        <td>
                            <span class="badge bg-${log.success ? 'success' : 'danger'}">
                                ${log.success ? 'Success' : 'Denied'}
                            </span>
                        </td>
                        <td>${log.reason || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        // Add system
        async function addSystem() {
            const formData = {
                system_id: document.getElementById('systemId').value,
                owner_id: document.getElementById('ownerId').value,
                owner_organization_id: document.getElementById('organizationId').value,
                access_level: document.getElementById('accessLevel').value,
                allow_sharing: document.getElementById('allowSharing').value === 'true',
                requires_license: document.getElementById('requiresLicense').value === 'true'
            };

            try {
                const response = await fetch('/api/access-control/systems', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addSystemModal')).hide();
                    loadSystems();
                    loadMetrics();
                } else {
                    alert('Error adding system');
                }
            } catch (error) {
                console.error('Error adding system:', error);
                alert('Error adding system');
            }
        }

        // Assign role
        async function assignRole() {
            const formData = {
                system_id: document.getElementById('roleSystemId').value,
                user_id: document.getElementById('roleUserId').value,
                organization_id: document.getElementById('roleOrganizationId').value,
                role_type: document.getElementById('roleType').value,
                granted_by: document.getElementById('grantedBy').value
            };

            try {
                const response = await fetch('/api/access-control/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('assignRoleModal')).hide();
                    loadRoles();
                    loadMetrics();
                } else {
                    alert('Error assigning role');
                }
            } catch (error) {
                console.error('Error assigning role:', error);
                alert('Error assigning role');
            }
        }

        // Create invite
        async function createInvite() {
            const formData = {
                system_id: document.getElementById('inviteSystemId').value,
                invited_email: document.getElementById('inviteEmail').value,
                role_type: document.getElementById('inviteRoleType').value,
                invited_by: document.getElementById('invitedBy').value,
                message: document.getElementById('inviteMessage').value
            };

            try {
                const response = await fetch('/api/access-control/invites', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createInviteModal')).hide();
                    loadInvites();
                    loadMetrics();
                } else {
                    alert('Error creating invite');
                }
            } catch (error) {
                console.error('Error creating invite:', error);
                alert('Error creating invite');
            }
        }

        // Create share link
        async function createShareLink() {
            const formData = {
                system_id: document.getElementById('shareSystemId').value,
                access_level: document.getElementById('shareAccessLevel').value,
                created_by: document.getElementById('shareCreatedBy').value,
                expires_in_days: document.getElementById('shareExpiresIn').value || null,
                max_uses: document.getElementById('shareMaxUses').value || null,
                password: document.getElementById('sharePassword').value || null
            };

            try {
                const response = await fetch('/api/access-control/share-links', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('createShareLinkModal')).hide();
                    loadShareLinks();
                } else {
                    alert('Error creating share link');
                }
            } catch (error) {
                console.error('Error creating share link:', error);
                alert('Error creating share link');
            }
        }

        // Search logs
        function searchLogs() {
            const searchTerm = document.getElementById('logSearchInput').value;
            // Implement log search functionality
            console.log('Searching logs for:', searchTerm);
        }

        // Utility functions
        function copyLink(linkId) {
            const link = `${window.location.origin}/share/${linkId}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        function revokeRole(userId, systemId) {
            if (confirm('Are you sure you want to revoke this role?')) {
                // Implement role revocation
                console.log('Revoking role for:', userId, systemId);
            }
        }

        function resendInvite(inviteId) {
            // Implement invite resend
            console.log('Resending invite:', inviteId);
        }

        function cancelInvite(inviteId) {
            if (confirm('Are you sure you want to cancel this invite?')) {
                // Implement invite cancellation
                console.log('Canceling invite:', inviteId);
            }
        }

        function deleteLink(linkId) {
            if (confirm('Are you sure you want to delete this share link?')) {
                // Implement link deletion
                console.log('Deleting link:', linkId);
            }
        }

        function editSystem(systemId) {
            currentSystemId = systemId;
            // Implement system editing
            console.log('Editing system:', systemId);
        }

        function deleteSystem(systemId) {
            if (confirm('Are you sure you want to delete this system access control?')) {
                // Implement system deletion
                console.log('Deleting system:', systemId);
            }
        }
    </script>
</body>
</html>
