<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Agent - System Builder Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .agent-message {
            background-color: white;
            border: 1px solid #dee2e6;
        }
        .system-message {
            background-color: #e9ecef;
            color: #6c757d;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }
        .ticket-card {
            border-left: 4px solid #007bff;
        }
        .ticket-urgent {
            border-left-color: #dc3545;
        }
        .ticket-high {
            border-left-color: #fd7e14;
        }
        .ticket-medium {
            border-left-color: #ffc107;
        }
        .ticket-low {
            border-left-color: #28a745;
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .priority-badge {
            font-size: 0.75rem;
        }
        .knowledge-card {
            transition: transform 0.2s;
        }
        .knowledge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .context-panel {
            background-color: #f8f9fa;
            border-left: 1px solid #dee2e6;
        }
        .loading-spinner {
            display: none;
        }
        .feedback-buttons {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-headset"></i> AI Support Agent</h2>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="showChat()">
                            <i class="fas fa-comments"></i> Chat
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="showTickets()">
                            <i class="fas fa-ticket-alt"></i> Tickets
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="showKnowledge()">
                            <i class="fas fa-book"></i> Knowledge
                        </button>
                    </div>
                </div>

                <!-- Chat Interface -->
                <div id="chat-interface">
                    <div class="chat-container" id="chat-messages">
                        <div class="message system-message">
                            <i class="fas fa-robot"></i> AI Support Agent is ready to help! Ask me anything about System Builder.
                        </div>
                    </div>
                    
                    <div class="input-group mt-3">
                        <input type="text" class="form-control" id="chat-input" placeholder="Type your question here...">
                        <button class="btn btn-primary" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    
                    <div class="loading-spinner text-center mt-3" id="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">AI is thinking...</p>
                    </div>
                    
                    <div class="feedback-buttons mt-3" id="feedback-buttons">
                        <small class="text-muted">Was this helpful?</small>
                        <button class="btn btn-sm btn-outline-success ms-2" onclick="provideFeedback('helpful')">
                            <i class="fas fa-thumbs-up"></i> Yes
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1" onclick="provideFeedback('not_helpful')">
                            <i class="fas fa-thumbs-down"></i> No
                        </button>
                    </div>
                </div>

                <!-- Tickets Interface -->
                <div id="tickets-interface" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Support Tickets</h4>
                        <button class="btn btn-primary" onclick="createNewTicket()">
                            <i class="fas fa-plus"></i> New Ticket
                        </button>
                    </div>
                    
                    <div class="row" id="tickets-list">
                        <!-- Tickets will be loaded here -->
                    </div>
                </div>

                <!-- Knowledge Base Interface -->
                <div id="knowledge-interface" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Knowledge Base</h4>
                        <button class="btn btn-primary" onclick="createKnowledgeArticle()">
                            <i class="fas fa-plus"></i> New Article
                        </button>
                    </div>
                    
                    <div class="row" id="knowledge-list">
                        <!-- Knowledge articles will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-md-4">
                <div class="context-panel p-3">
                    <h5><i class="fas fa-info-circle"></i> Support Context</h5>
                    
                    <!-- System Selection -->
                    <div class="mb-3">
                        <label for="system-select" class="form-label">Select System</label>
                        <select class="form-select" id="system-select" onchange="loadSystemContext()">
                            <option value="">All Systems</option>
                        </select>
                    </div>
                    
                    <!-- System Context -->
                    <div id="system-context">
                        <h6>System Information</h6>
                        <div id="context-details">
                            <p class="text-muted">Select a system to view context</p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Quick Actions -->
                    <h6>Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="escalateIssue()">
                            <i class="fas fa-arrow-up"></i> Escalate Issue
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="searchKnowledge()">
                            <i class="fas fa-search"></i> Search Knowledge
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="createTicket()">
                            <i class="fas fa-ticket-alt"></i> Create Ticket
                        </button>
                    </div>
                    
                    <hr>
                    
                    <!-- Statistics -->
                    <h6>Support Stats</h6>
                    <div id="support-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="stats-card p-2 rounded">
                                    <h4 id="total-tickets">0</h4>
                                    <small>Total Tickets</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card p-2 rounded">
                                    <h4 id="resolution-rate">0%</h4>
                                    <small>Resolution Rate</small>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <div class="stats-card p-2 rounded">
                                    <h4 id="avg-satisfaction">0</h4>
                                    <small>Avg Satisfaction</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stats-card p-2 rounded">
                                    <h4 id="active-sessions">0</h4>
                                    <small>Active Sessions</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Ticket Modal -->
    <div class="modal fade" id="newTicketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Support Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ticket-form">
                        <div class="mb-3">
                            <label for="ticket-subject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="ticket-subject" required>
                        </div>
                        <div class="mb-3">
                            <label for="ticket-description" class="form-label">Description</label>
                            <textarea class="form-control" id="ticket-description" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="ticket-priority" class="form-label">Priority</label>
                            <select class="form-select" id="ticket-priority" required>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ticket-category" class="form-label">Category</label>
                            <select class="form-select" id="ticket-category" required>
                                <option value="technical">Technical</option>
                                <option value="billing">Billing</option>
                                <option value="feature_request">Feature Request</option>
                                <option value="bug_report">Bug Report</option>
                                <option value="onboarding">Onboarding</option>
                                <option value="integration">Integration</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitTicket()">Create Ticket</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Article Modal -->
    <div class="modal fade" id="knowledgeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Knowledge Base Article</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="knowledge-form">
                        <div class="mb-3">
                            <label for="article-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="article-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="article-content" class="form-label">Content</label>
                            <textarea class="form-control" id="article-content" rows="8" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="article-category" class="form-label">Category</label>
                            <select class="form-select" id="article-category" required>
                                <option value="technical">Technical</option>
                                <option value="billing">Billing</option>
                                <option value="feature_request">Feature Request</option>
                                <option value="bug_report">Bug Report</option>
                                <option value="onboarding">Onboarding</option>
                                <option value="integration">Integration</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="article-tags" class="form-label">Tags (comma-separated)</label>
                            <input type="text" class="form-control" id="article-tags" placeholder="api, deployment, troubleshooting">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitKnowledgeArticle()">Save Article</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSessionId = null;
        let currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
        let lastMessageId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSupportStatistics();
            loadSystems();
            createSupportSession();
        });

        // Chat Functions
        function showChat() {
            document.getElementById('chat-interface').style.display = 'block';
            document.getElementById('tickets-interface').style.display = 'none';
            document.getElementById('knowledge-interface').style.display = 'none';
        }

        function showTickets() {
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('tickets-interface').style.display = 'block';
            document.getElementById('knowledge-interface').style.display = 'none';
            loadTickets();
        }

        function showKnowledge() {
            document.getElementById('chat-interface').style.display = 'none';
            document.getElementById('tickets-interface').style.display = 'none';
            document.getElementById('knowledge-interface').style.display = 'block';
            loadKnowledgeBase();
        }

        function createSupportSession() {
            fetch('/api/support/session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: currentUserId,
                    system_id: document.getElementById('system-select').value
                })
            })
            .then(response => response.json())
            .then(data => {
                currentSessionId = data.session_id;
            })
            .catch(error => console.error('Error creating session:', error));
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading spinner
            document.getElementById('loading-spinner').style.display = 'block';
            document.getElementById('feedback-buttons').style.display = 'none';
            
            // Send to API
            fetch('/api/support/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    user_id: currentUserId,
                    query: message,
                    system_id: document.getElementById('system-select').value
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-spinner').style.display = 'none';
                
                // Add agent response
                addMessage(data.response, 'agent');
                lastMessageId = data.message_id;
                
                // Show feedback buttons
                document.getElementById('feedback-buttons').style.display = 'block';
                
                // Update context if provided
                if (data.context_used && data.context_used.length > 0) {
                    updateContextPanel(data.context_used);
                }
            })
            .catch(error => {
                console.error('Error sending message:', error);
                document.getElementById('loading-spinner').style.display = 'none';
                addMessage('Sorry, I encountered an error. Please try again.', 'agent');
            });
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function provideFeedback(type) {
            if (!lastMessageId) return;
            
            fetch('/api/support/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message_id: lastMessageId,
                    user_feedback: type,
                    satisfaction_score: type === 'helpful' ? 5 : 1
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('feedback-buttons').style.display = 'none';
                addMessage('Thank you for your feedback!', 'system');
            })
            .catch(error => console.error('Error providing feedback:', error));
        }

        // Ticket Functions
        function loadTickets() {
            fetch('/api/support/tickets')
            .then(response => response.json())
            .then(tickets => {
                const ticketsList = document.getElementById('tickets-list');
                ticketsList.innerHTML = '';
                
                tickets.forEach(ticket => {
                    const ticketCard = createTicketCard(ticket);
                    ticketsList.appendChild(ticketCard);
                });
            })
            .catch(error => console.error('Error loading tickets:', error));
        }

        function createTicketCard(ticket) {
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-3';
            
            const priorityClass = `ticket-${ticket.priority}`;
            const statusBadge = getStatusBadge(ticket.status);
            const priorityBadge = getPriorityBadge(ticket.priority);
            
            col.innerHTML = `
                <div class="card ticket-card ${priorityClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title">${ticket.subject}</h6>
                            <div>
                                ${statusBadge}
                                ${priorityBadge}
                            </div>
                        </div>
                        <p class="card-text text-muted">${ticket.description.substring(0, 100)}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Created: ${new Date(ticket.created_at).toLocaleDateString()}</small>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTicket('${ticket.ticket_id}')">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function getStatusBadge(status) {
            const statusColors = {
                'open': 'primary',
                'in_progress': 'warning',
                'waiting_for_user': 'info',
                'resolved': 'success',
                'closed': 'secondary',
                'escalated': 'danger'
            };
            
            return `<span class="badge bg-${statusColors[status] || 'secondary'} status-badge">${status.replace('_', ' ')}</span>`;
        }

        function getPriorityBadge(priority) {
            const priorityColors = {
                'low': 'success',
                'medium': 'warning',
                'high': 'danger',
                'urgent': 'danger'
            };
            
            return `<span class="badge bg-${priorityColors[priority] || 'secondary'} priority-badge">${priority}</span>`;
        }

        function createNewTicket() {
            const modal = new bootstrap.Modal(document.getElementById('newTicketModal'));
            modal.show();
        }

        function submitTicket() {
            const form = document.getElementById('ticket-form');
            const formData = new FormData(form);
            
            const ticketData = {
                subject: document.getElementById('ticket-subject').value,
                description: document.getElementById('ticket-description').value,
                priority: document.getElementById('ticket-priority').value,
                category: document.getElementById('ticket-category').value,
                user_id: currentUserId
            };
            
            fetch('/api/support/tickets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(ticketData)
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('newTicketModal')).hide();
                form.reset();
                loadTickets();
            })
            .catch(error => console.error('Error creating ticket:', error));
        }

        // Knowledge Base Functions
        function loadKnowledgeBase() {
            fetch('/api/support/knowledge')
            .then(response => response.json())
            .then(articles => {
                const knowledgeList = document.getElementById('knowledge-list');
                knowledgeList.innerHTML = '';
                
                articles.forEach(article => {
                    const articleCard = createKnowledgeCard(article);
                    knowledgeList.appendChild(articleCard);
                });
            })
            .catch(error => console.error('Error loading knowledge base:', error));
        }

        function createKnowledgeCard(article) {
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-3';
            
            col.innerHTML = `
                <div class="card knowledge-card">
                    <div class="card-body">
                        <h6 class="card-title">${article.title}</h6>
                        <p class="card-text text-muted">${article.content.substring(0, 150)}...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-primary">${article.category}</span>
                            <small class="text-muted">Views: ${article.view_count}</small>
                        </div>
                        <div class="mt-2">
                            ${article.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            return col;
        }

        function createKnowledgeArticle() {
            const modal = new bootstrap.Modal(document.getElementById('knowledgeModal'));
            modal.show();
        }

        function submitKnowledgeArticle() {
            const articleData = {
                title: document.getElementById('article-title').value,
                content: document.getElementById('article-content').value,
                category: document.getElementById('article-category').value,
                tags: document.getElementById('article-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };
            
            fetch('/api/support/knowledge', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(articleData)
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('knowledgeModal')).hide();
                document.getElementById('knowledge-form').reset();
                loadKnowledgeBase();
            })
            .catch(error => console.error('Error creating knowledge article:', error));
        }

        // Context Functions
        function loadSystems() {
            fetch('/api/systems')
            .then(response => response.json())
            .then(systems => {
                const systemSelect = document.getElementById('system-select');
                systemSelect.innerHTML = '<option value="">All Systems</option>';
                
                systems.forEach(system => {
                    const option = document.createElement('option');
                    option.value = system.system_id;
                    option.textContent = system.name;
                    systemSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error loading systems:', error));
        }

        function loadSystemContext() {
            const systemId = document.getElementById('system-select').value;
            if (!systemId) {
                document.getElementById('context-details').innerHTML = '<p class="text-muted">Select a system to view context</p>';
                return;
            }
            
            fetch(`/api/support/context/${systemId}`)
            .then(response => response.json())
            .then(contexts => {
                const contextDetails = document.getElementById('context-details');
                contextDetails.innerHTML = '';
                
                contexts.forEach(context => {
                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'mb-2 p-2 bg-light rounded';
                    contextDiv.innerHTML = `
                        <strong>${context.context_type}:</strong>
                        <p class="mb-1 small">${context.content.substring(0, 100)}...</p>
                        <small class="text-muted">Relevance: ${(context.relevance_score * 100).toFixed(1)}%</small>
                    `;
                    contextDetails.appendChild(contextDiv);
                });
            })
            .catch(error => console.error('Error loading system context:', error));
        }

        function updateContextPanel(contexts) {
            const contextDetails = document.getElementById('context-details');
            contextDetails.innerHTML = '<h6>Relevant Context</h6>';
            
            contexts.forEach(context => {
                const contextDiv = document.createElement('div');
                contextDiv.className = 'mb-2 p-2 bg-light rounded';
                contextDiv.innerHTML = `
                    <strong>${context.context_type}:</strong>
                    <p class="mb-1 small">${context.content.substring(0, 100)}...</p>
                    <small class="text-muted">Relevance: ${(context.relevance_score * 100).toFixed(1)}%</small>
                `;
                contextDetails.appendChild(contextDiv);
            });
        }

        // Statistics Functions
        function loadSupportStatistics() {
            fetch('/api/support/statistics')
            .then(response => response.json())
            .then(stats => {
                document.getElementById('total-tickets').textContent = stats.total_tickets;
                document.getElementById('resolution-rate').textContent = stats.resolution_rate.toFixed(1) + '%';
                document.getElementById('avg-satisfaction').textContent = stats.average_satisfaction.toFixed(1);
                document.getElementById('active-sessions').textContent = stats.active_sessions;
            })
            .catch(error => console.error('Error loading statistics:', error));
        }

        // Utility Functions
        function escalateIssue() {
            const reason = prompt('Please provide a reason for escalation:');
            if (reason) {
                fetch('/api/support/escalate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticket_id: 'current_ticket',
                        reason: reason,
                        escalation_level: 'tier2'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Issue escalated successfully');
                    } else {
                        alert('Failed to escalate issue');
                    }
                })
                .catch(error => console.error('Error escalating issue:', error));
            }
        }

        function searchKnowledge() {
            const query = prompt('Enter search terms:');
            if (query) {
                // Implement knowledge search
                console.log('Searching for:', query);
            }
        }

        function createTicket() {
            createNewTicket();
        }

        // Keyboard shortcuts
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
