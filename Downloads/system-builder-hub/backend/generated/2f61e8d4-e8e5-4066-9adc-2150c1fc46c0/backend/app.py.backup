from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
import uvicorn
import os
from routers import accounts, contacts, deals, pipelines, activities, communications, notes, templates, 

from db import check_db_exists
from seed import initialize_database
from seed_auth import seed_auth_data

app = FastAPI(title="CRM Flagship", version="1.0.0")

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.on_event("startup")
async def startup_event():
    """Initialize database on startup if it doesn't exist"""
    if not check_db_exists():
        print("Database not found, initializing with seed data...")
        initialize_database()
        print("Seeding authentication data...")
        seed_auth_data()
    else:
        print("Database found, skipping initialization")

# Include routers
app.include_router(auth.router, prefix="/api/auth", tags=["authentication"])
app.include_router(accounts.router, prefix="/api/accounts", tags=["accounts"])
app.include_router(contacts.router, prefix="/api/contacts", tags=["contacts"])
app.include_router(deals.router, prefix="/api/deals", tags=["deals"])
app.include_router(pipelines.router, prefix="/api/pipelines", tags=["pipelines"])
app.include_router(activities.router, prefix="/api/activities", tags=["activities"])
app.include_router(communications.router, prefix="/api/communications", tags=["communications"])
app.include_router(notes.router, prefix="/api", tags=["notes"])
app.include_router(templates.router, prefix="/api/templates", tags=["templates"])
app.include_router(automations.router, prefix="/api/automations", tags=["automations"])
app.include_router(analytics.router, prefix="/api/analytics", tags=["analytics"])
app.include_router(webhooks.router, prefix="/api/webhooks", tags=["webhooks"])

@app.get("/api/health")
async def health_check():
    return {"status": "healthy", "service": "CRM Flagship"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
