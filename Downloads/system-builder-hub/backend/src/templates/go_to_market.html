<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš€ Go-To-Market Engine - System Builder Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }
        
        .main-content {
            padding: 2rem 0;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1.5rem;
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-planning { background: #fff3cd; color: #856404; }
        .status-assets_created { background: #d1ecf1; color: #0c5460; }
        .status-microsite_deployed { background: #d4edda; color: #155724; }
        .status-launched { background: #cce5ff; color: #004085; }
        .status-optimizing { background: #f8d7da; color: #721c24; }
        
        .metric-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 1rem;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 25px;
            margin-right: 0.5rem;
            padding: 0.75rem 1.5rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .back-to-dashboard {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-to-dashboard:hover {
            color: #764ba2;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step.active {
            display: block;
        }
        
        .preview-frame {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            min-height: 400px;
            background: white;
        }
        
        .checklist-item {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            border-left: 4px solid #e9ecef;
        }
        
        .checklist-item.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .checklist-item.pending {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-rocket me-2"></i>System Builder Hub
            </a>
            <a href="/" class="back-to-dashboard">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-white text-center mb-3">
                        <i class="fas fa-rocket me-3"></i>Go-To-Market Engine
                    </h1>
                    <p class="text-white text-center opacity-75">
                        Automated Marketing, Legal & Commercialization Assets
                    </p>
                </div>
            </div>

            <!-- Metrics Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-bundles">0</div>
                        <div class="metric-label">GTM Bundles</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="launched-systems">0</div>
                        <div class="metric-label">Launched Systems</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="total-assets">0</div>
                        <div class="metric-label">Generated Assets</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value" id="conversion-rate">0%</div>
                        <div class="metric-label">Avg Conversion Rate</div>
                    </div>
                </div>
            </div>

            <!-- Main Navigation Tabs -->
            <ul class="nav nav-tabs" id="gtmTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="bundles-tab" data-bs-toggle="tab" data-bs-target="#bundles" type="button" role="tab">
                        <i class="fas fa-box me-2"></i>GTM Bundles
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="wizard-tab" data-bs-toggle="tab" data-bs-target="#wizard" type="button" role="tab">
                        <i class="fas fa-magic me-2"></i>GTM Wizard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assets-tab" data-bs-toggle="tab" data-bs-target="#assets" type="button" role="tab">
                        <i class="fas fa-images me-2"></i>Assets
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="gtmTabContent">
                <!-- GTM Bundles Tab -->
                <div class="tab-pane fade show active" id="bundles" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-box me-2"></i>GTM Bundles
                            </h5>
                            <button class="btn btn-light btn-sm" onclick="createNewBundle()">
                                <i class="fas fa-plus me-2"></i>Create Bundle
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>System Name</th>
                                            <th>Stage</th>
                                            <th>Created</th>
                                            <th>Assets</th>
                                            <th>Analytics</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bundles-table">
                                        <!-- GTM bundles will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GTM Wizard Tab -->
                <div class="tab-pane fade" id="wizard" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-magic me-2"></i>GTM Wizard
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Wizard Steps -->
                            <div class="wizard-step active" id="step-1">
                                <h4>Step 1: System Information</h4>
                                <form id="system-info-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="system-name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">System Type</label>
                                                <select class="form-select" id="system-type" required>
                                                    <option value="">Select type</option>
                                                    <option value="saas">SaaS Application</option>
                                                    <option value="marketplace">Marketplace</option>
                                                    <option value="web_app">Web Application</option>
                                                    <option value="mobile_app">Mobile Application</option>
                                                    <option value="api">API Service</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="system-description" rows="3" required></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Target Audience</label>
                                                <select class="form-select" id="target-audience" required>
                                                    <option value="">Select audience</option>
                                                    <option value="business">Business</option>
                                                    <option value="consumer">Consumer</option>
                                                    <option value="developer">Developer</option>
                                                    <option value="enterprise">Enterprise</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Industry</label>
                                                <select class="form-select" id="industry" required>
                                                    <option value="">Select industry</option>
                                                    <option value="technology">Technology</option>
                                                    <option value="healthcare">Healthcare</option>
                                                    <option value="finance">Finance</option>
                                                    <option value="education">Education</option>
                                                    <option value="ecommerce">E-commerce</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Next Step <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </form>
                            </div>

                            <div class="wizard-step" id="step-2">
                                <h4>Step 2: Company Information</h4>
                                <form id="company-info-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Company Name</label>
                                                <input type="text" class="form-control" id="company-name" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Legal Region</label>
                                                <select class="form-select" id="legal-region" required>
                                                    <option value="">Select region</option>
                                                    <option value="us">United States</option>
                                                    <option value="eu">European Union</option>
                                                    <option value="global">Global</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Website</label>
                                                <input type="url" class="form-control" id="company-website">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Contact Email</label>
                                                <input type="email" class="form-control" id="contact-email" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Company Address</label>
                                        <textarea class="form-control" id="company-address" rows="2"></textarea>
                                    </div>
                                    
                                    <button type="button" class="btn btn-secondary me-2" onclick="prevStep()">
                                        <i class="fas fa-arrow-left me-2"></i>Previous
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                                        Next Step <i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                </form>
                            </div>

                            <div class="wizard-step" id="step-3">
                                <h4>Step 3: Marketing Preferences</h4>
                                <form id="marketing-form">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Primary Marketing Channel</label>
                                                <select class="form-select" id="primary-channel" required>
                                                    <option value="">Select channel</option>
                                                    <option value="content_marketing">Content Marketing</option>
                                                    <option value="paid_ads">Paid Advertising</option>
                                                    <option value="social_media">Social Media</option>
                                                    <option value="email_marketing">Email Marketing</option>
                                                    <option value="affiliate">Affiliate Marketing</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Budget Range</label>
                                                <select class="form-select" id="budget-range" required>
                                                    <option value="">Select budget</option>
                                                    <option value="low">$0 - $1,000</option>
                                                    <option value="medium">$1,000 - $10,000</option>
                                                    <option value="high">$10,000+</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Marketing Goals</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="goal-awareness" value="awareness">
                                            <label class="form-check-label" for="goal-awareness">
                                                Brand Awareness
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="goal-leads" value="leads">
                                            <label class="form-check-label" for="goal-leads">
                                                Lead Generation
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="goal-sales" value="sales">
                                            <label class="form-check-label" for="goal-sales">
                                                Direct Sales
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-secondary me-2" onclick="prevStep()">
                                        <i class="fas fa-arrow-left me-2"></i>Previous
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="generateGTMBundle()">
                                        <i class="fas fa-magic me-2"></i>Generate GTM Bundle
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-line me-2"></i>Conversion Funnel
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="conversionChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-pie me-2"></i>Traffic Sources
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="trafficChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Performance Metrics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Value</th>
                                            <th>Change</th>
                                            <th>Trend</th>
                                        </tr>
                                    </thead>
                                    <tbody id="metrics-table">
                                        <!-- Metrics will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assets Tab -->
                <div class="tab-pane fade" id="assets" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-images me-2"></i>Generated Assets
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="assets-grid">
                                        <!-- Assets will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-eye me-2"></i>Live Preview
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="preview-frame" id="asset-preview">
                                        <div class="text-center text-muted p-4">
                                            <i class="fas fa-image fa-3x mb-3"></i>
                                            <p>Select an asset to preview</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Create Bundle Modal -->
    <div class="modal fade" id="createBundleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Create New GTM Bundle
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-bundle-form">
                        <div class="mb-3">
                            <label class="form-label">System ID</label>
                            <input type="text" class="form-control" id="modal-system-id" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Organization ID</label>
                            <input type="text" class="form-control" id="modal-org-id" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">System Metadata (JSON)</label>
                            <textarea class="form-control" id="modal-metadata" rows="5" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateBundle()">
                        <i class="fas fa-plus me-2"></i>Create Bundle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bundle Details Modal -->
    <div class="modal fade" id="bundleDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-box me-2"></i>GTM Bundle Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="bundle-details-content">
                        <!-- Bundle details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentOrganizationId = 'default-org';
        let currentStep = 1;
        let totalSteps = 3;
        let conversionChart = null;
        let trafficChart = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            initializeCharts();
            setupEventListeners();
        });

        function loadDashboardData() {
            loadGTMBundles();
            loadMetrics();
        }

        function loadGTMBundles() {
            fetch(`/api/gtm/bundles?organization_id=${currentOrganizationId}`)
                .then(response => response.json())
                .then(bundles => {
                    const tbody = document.getElementById('bundles-table');
                    tbody.innerHTML = '';
                    
                    bundles.forEach(bundle => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bundle.blueprint.system_name}</td>
                            <td><span class="status-badge status-${bundle.stage}">${bundle.stage}</span></td>
                            <td>${new Date(bundle.created_at).toLocaleDateString()}</td>
                            <td>${Object.keys(bundle.assets).length} assets</td>
                            <td>${bundle.conversion_events.length} events</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewBundleDetails('${bundle.bundle_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportBundle('${bundle.bundle_id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="deployBundle('${bundle.bundle_id}')">
                                    <i class="fas fa-rocket"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading GTM bundles:', error);
                    document.getElementById('bundles-table').innerHTML = 
                        '<tr><td colspan="6" class="text-center text-muted">Error loading GTM bundles</td></tr>';
                });
        }

        function loadMetrics() {
            // Load dashboard metrics
            fetch(`/api/gtm/metrics?organization_id=${currentOrganizationId}`)
                .then(response => response.json())
                .then(metrics => {
                    document.getElementById('total-bundles').textContent = metrics.total_bundles || 0;
                    document.getElementById('launched-systems').textContent = metrics.launched_systems || 0;
                    document.getElementById('total-assets').textContent = metrics.total_assets || 0;
                    document.getElementById('conversion-rate').textContent = (metrics.avg_conversion_rate || 0).toFixed(1) + '%';
                })
                .catch(error => {
                    console.error('Error loading metrics:', error);
                });
        }

        function initializeCharts() {
            // Conversion funnel chart
            const conversionCtx = document.getElementById('conversionChart').getContext('2d');
            conversionChart = new Chart(conversionCtx, {
                type: 'funnel',
                data: {
                    labels: ['Awareness', 'Interest', 'Consideration', 'Conversion'],
                    datasets: [{
                        data: [1000, 800, 600, 400],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });

            // Traffic sources chart
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(trafficCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Organic', 'Paid', 'Social', 'Direct', 'Referral'],
                    datasets: [{
                        data: [40, 25, 20, 10, 5],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function setupEventListeners() {
            // Form validation and step navigation
            document.getElementById('system-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                nextStep();
            });
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.add('active');
            }
        }

        function createNewBundle() {
            const modal = new bootstrap.Modal(document.getElementById('createBundleModal'));
            modal.show();
        }

        function submitCreateBundle() {
            const formData = {
                system_id: document.getElementById('modal-system-id').value,
                organization_id: document.getElementById('modal-org-id').value,
                system_metadata: JSON.parse(document.getElementById('modal-metadata').value)
            };

            fetch('/api/gtm/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.bundle_id) {
                    bootstrap.Modal.getInstance(document.getElementById('createBundleModal')).hide();
                    loadGTMBundles();
                    showAlert('GTM bundle created successfully!', 'success');
                } else {
                    showAlert('Failed to create GTM bundle', 'error');
                }
            })
            .catch(error => {
                console.error('Error creating GTM bundle:', error);
                showAlert('Error creating GTM bundle', 'error');
            });
        }

        function generateGTMBundle() {
            // Collect all form data
            const systemMetadata = {
                name: document.getElementById('system-name').value,
                type: document.getElementById('system-type').value,
                description: document.getElementById('system-description').value,
                target_audience: document.getElementById('target-audience').value,
                industry: document.getElementById('industry').value,
                company_info: {
                    name: document.getElementById('company-name').value,
                    region: document.getElementById('legal-region').value,
                    website: document.getElementById('company-website').value,
                    email: document.getElementById('contact-email').value,
                    address: document.getElementById('company-address').value
                },
                marketing_preferences: {
                    primary_channel: document.getElementById('primary-channel').value,
                    budget_range: document.getElementById('budget-range').value,
                    goals: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
                }
            };

            const formData = {
                system_id: 'auto-generated',
                organization_id: currentOrganizationId,
                system_metadata: systemMetadata
            };

            fetch('/api/gtm/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.bundle_id) {
                    showAlert('GTM bundle generated successfully!', 'success');
                    // Switch to bundles tab to see the new bundle
                    document.getElementById('bundles-tab').click();
                    loadGTMBundles();
                } else {
                    showAlert('Failed to generate GTM bundle', 'error');
                }
            })
            .catch(error => {
                console.error('Error generating GTM bundle:', error);
                showAlert('Error generating GTM bundle', 'error');
            });
        }

        function viewBundleDetails(bundleId) {
            fetch(`/api/gtm/bundle/${bundleId}`)
                .then(response => response.json())
                .then(bundle => {
                    const modal = new bootstrap.Modal(document.getElementById('bundleDetailsModal'));
                    document.getElementById('bundle-details-content').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>System Information</h6>
                                <p><strong>Name:</strong> ${bundle.blueprint.system_name}</p>
                                <p><strong>Type:</strong> ${bundle.blueprint.system_type}</p>
                                <p><strong>Target Audience:</strong> ${bundle.blueprint.target_audience}</p>
                                <p><strong>Industry:</strong> ${bundle.blueprint.industry}</p>
                                <p><strong>Stage:</strong> <span class="status-badge status-${bundle.stage}">${bundle.stage}</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>GTM Components</h6>
                                <p><strong>Blueprint:</strong> Generated</p>
                                <p><strong>Legal Docs:</strong> ${Object.keys(bundle.legal_docs).length} documents</p>
                                <p><strong>Sales Funnel:</strong> ${bundle.sales_funnel.stages.length} stages</p>
                                <p><strong>Marketing Strategy:</strong> Complete</p>
                                <p><strong>Assets:</strong> ${Object.keys(bundle.assets).length} generated</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Elevator Pitch</h6>
                            <p>${bundle.blueprint.elevator_pitch}</p>
                        </div>
                        <div class="mt-3">
                            <h6>Value Propositions</h6>
                            <ul>
                                ${bundle.blueprint.value_propositions.map(prop => `<li>${prop}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    modal.show();
                })
                .catch(error => {
                    console.error('Error loading bundle details:', error);
                });
        }

        function exportBundle(bundleId) {
            const format = prompt('Export format (zip/github):', 'zip');
            if (!format) return;

            fetch(`/api/gtm/export/${bundleId}?format=${format}`)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `gtm_bundle_${bundleId}.${format === 'zip' ? 'zip' : 'tar.gz'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showAlert('Bundle exported successfully!', 'success');
                })
                .catch(error => {
                    console.error('Error exporting bundle:', error);
                    showAlert('Error exporting bundle', 'error');
                });
        }

        function deployBundle(bundleId) {
            if (confirm('Deploy this GTM bundle to microsite?')) {
                fetch(`/api/gtm/deploy/${bundleId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Bundle deployed successfully!', 'success');
                        loadGTMBundles();
                    } else {
                        showAlert('Failed to deploy bundle', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deploying bundle:', error);
                    showAlert('Error deploying bundle', 'error');
                });
            }
        }

        function showAlert(message, type) {
            // Simple alert implementation
            alert(message);
        }

        // Auto-refresh data every 30 seconds
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
