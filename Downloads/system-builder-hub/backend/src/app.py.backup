"""
Main Flask application factory
"""
import os
import logging
from flask import Flask, jsonify, request
from flask_cors import CORS

# Import blueprints
from llm_config_api import llm_config_bp
from llm_status_api import bp as llm_status_bp
from llm_dry_run_api import llm_dry_run_bp
from builder_api import builder_api_bp
from preview_ui import bp as preview_ui_bp
from agent.router import bp as agent_bp
from auth_api import bp as auth_bp
from payments_api import bp as payments_bp
from file_store_api import bp as file_store_bp

# Import database helpers
from db import close_db

logger = logging.getLogger(__name__)

def create_app():
    """Create and configure the Flask application"""
    app = Flask(__name__, template_folder="../templates", static_folder="../static")
    
    # Configure CORS
    CORS(app, origins=['http://localhost:5001', 'http://127.0.0.1:5001'])
    
    # Configure database
    app.config['DATABASE'] = os.path.join(app.instance_path, 'app.db')
    
    # Configure public base URL for agent testing
    app.config['PUBLIC_BASE_URL'] = os.environ.get('PUBLIC_BASE_URL', 'http://localhost:5001')
    
    # Configure auth secret key
    app.config['AUTH_SECRET_KEY'] = os.environ.get('AUTH_SECRET_KEY', 'default-secret-key-change-in-production')
    
    # Configure Stripe keys
    app.config['STRIPE_SECRET_KEY'] = os.environ.get('STRIPE_SECRET_KEY', 'sk_test_mock')
    app.config['STRIPE_WEBHOOK_SECRET'] = os.environ.get('STRIPE_WEBHOOK_SECRET', 'whsec_test')
    
    # Configure file upload settings
    app.config['MAX_CONTENT_LENGTH'] = 50 * 1024 * 1024  # 50MB max file size
    
    # Configure storage settings
    app.config['STORAGE_PROVIDER'] = os.environ.get('STORAGE_PROVIDER', 'local')
    app.config['S3_BUCKET_NAME'] = os.environ.get('S3_BUCKET_NAME')
    app.config['AWS_ACCESS_KEY_ID'] = os.environ.get('AWS_ACCESS_KEY_ID')
    app.config['AWS_SECRET_ACCESS_KEY'] = os.environ.get('AWS_SECRET_ACCESS_KEY')
    app.config['AWS_REGION'] = os.environ.get('AWS_REGION', 'us-east-1')
    app.config['S3_PRESIGN_EXPIRY_SECONDS'] = int(os.environ.get('S3_PRESIGN_EXPIRY_SECONDS', '900'))
    
    # Ensure instance folder exists
    try:
        os.makedirs(app.instance_path)
    except OSError:
        pass
    
    # Register database close function
    app.teardown_appcontext(close_db)
    
    # Register blueprints with error handling
    try:
        # Register LLM blueprints (conditional on feature flag)
        if os.environ.get('FEATURE_LLM_API', 'true').lower() == 'true':
            app.register_blueprint(llm_config_bp)
            app.register_blueprint(llm_status_bp)
            app.register_blueprint(llm_dry_run_bp)
            logger.info("LLM blueprints registered successfully")
        else:
            logger.warning("LLM API feature disabled - skipping LLM blueprint registration")
    except Exception as e:
        if os.environ.get('FLASK_ENV') == 'production':
            logger.error(f"Failed to register LLM blueprints: {e}")
            raise SystemExit(1)
        else:
            logger.warning(f"LLM blueprints not available: {e}")
    
    # Register core blueprints
    try:
        app.register_blueprint(builder_api_bp)
        app.register_blueprint(preview_ui_bp)
        app.register_blueprint(agent_bp)
        app.register_blueprint(auth_bp)
        app.register_blueprint(payments_bp)
        app.register_blueprint(file_store_bp)
        logger.info("Core blueprints registered successfully")
    except Exception as e:
        logger.error(f"Failed to register core blueprints: {e}")
        raise SystemExit(1)
    
    # Log registered routes
    llm_routes = [rule.rule for rule in app.url_map.iter_rules() if rule.rule.startswith('/api/llm')]
    agent_routes = [rule.rule for rule in app.url_map.iter_rules() if rule.rule.startswith('/api/agent')]
    auth_routes = [rule.rule for rule in app.url_map.iter_rules() if rule.rule.startswith('/api/auth')]
    payment_routes = [rule.rule for rule in app.url_map.iter_rules() if rule.rule.startswith('/api/payments')]
    file_routes = [rule.rule for rule in app.url_map.iter_rules() if rule.rule.startswith('/api/files')]
    logger.info(f"Registered LLM routes: {llm_routes}")
    logger.info(f"Registered Agent routes: {agent_routes}")
    logger.info(f"Registered Auth routes: {auth_routes}")
    logger.info(f"Registered Payment routes: {payment_routes}")
    logger.info(f"Registered File routes: {file_routes}")
    
    @app.route('/healthz')
    def healthz():
        """Health check endpoint"""
        return jsonify({
            'status': 'ok',
            'version': '1.0.0'
        })
    
    @app.route('/readiness')
    def readiness():
        """Readiness check endpoint"""
        from health import check_db
        
        db_path = app.config.get("DATABASE", "instance/app.db")
        db_ok, migrations_applied, _ = check_db(db_path)

        # LLM: optional
        feature_llm = app.config.get("FEATURE_LLM_API", True)
        llm_details = {"configured": False, "ok": False, "details": "not_configured"}

        try:
            if not feature_llm:
                llm_details = {"configured": False, "ok": False, "details": "disabled"}
            else:
                # Ask the status blueprint/service in a safe way
                try:
                    from llm_status_api import get_status_summary  # provide helper
                    s = get_status_summary()  # never throws
                    llm_details = {
                        "configured": s.get("configured", False),
                        "ok": s.get("ok", False),
                        "details": s.get("details", "not_configured"),
                    }
                except Exception:
                    # If imports fail in dev, don't crash readiness
                    llm_details = {"configured": False, "ok": False, "details": "not_configured"}
        except Exception as e:
            llm_details = {"configured": False, "ok": False, "details": f"error:{type(e).__name__}"}

        status = {
            "db": bool(db_ok),
            "migrations_applied": bool(migrations_applied),
            "llm": llm_details,
        }

        # Core rule: as long as DB is OK, return 200 (LLM is optional)
        http_code = 200 if db_ok else 503
        return jsonify(status), http_code
    
    @app.route('/')
    def index():
        """Root endpoint"""
        return jsonify({
            'message': 'System Builder Hub API',
            'version': '1.0.0',
            'endpoints': {
                'health': '/healthz',
                'readiness': '/readiness',
                'agent': '/api/agent',
                'auth': '/api/auth',
                'payments': '/api/payments',
                'files': '/api/files',
                'docs': '/docs'
            }
        })
    
    return app
