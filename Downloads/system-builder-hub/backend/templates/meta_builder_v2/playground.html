<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBH Meta-Builder v2 Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .monaco-editor {
            height: 400px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">Meta-Builder v2 Playground</h1>
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">Interactive</span>
                    </div>
                    <nav class="flex space-x-6">
                        <a href="/ui/meta/v2/" class="hover:text-blue-200 transition-colors">Portal</a>
                        <a href="/ui/meta/v2/playground" class="hover:text-blue-200 transition-colors">Playground</a>
                        <a href="/ui/meta/v2/runs" class="hover:text-blue-200 transition-colors">Runs</a>
                        <a href="/ui/meta/v2/history" class="hover:text-blue-200 transition-colors">History</a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Panel: Input -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Goal & Specification</h2>
                        
                        <!-- Input Mode Toggle -->
                        <div class="mb-4">
                            <div class="flex space-x-2">
                                <button 
                                    @click="inputMode = 'natural'" 
                                    :class="inputMode === 'natural' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-4 py-2 rounded-lg transition-colors"
                                >
                                    Natural Language
                                </button>
                                <button 
                                    @click="inputMode = 'dsl'" 
                                    :class="inputMode === 'dsl' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-4 py-2 rounded-lg transition-colors"
                                >
                                    DSL
                                </button>
                                <button 
                                    @click="inputMode = 'import'" 
                                    :class="inputMode === 'import' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-4 py-2 rounded-lg transition-colors"
                                >
                                    Import
                                </button>
                            </div>
                        </div>

                        <!-- Natural Language Input -->
                        <div v-if="inputMode === 'natural'" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                                <input 
                                    v-model="projectName" 
                                    type="text" 
                                    placeholder="My CRM System"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Goal Description</label>
                                <textarea 
                                    v-model="goalText" 
                                    rows="6"
                                    placeholder="Describe your system idea in natural language..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                ></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Example Prompts</label>
                                <div class="space-y-2">
                                    <button 
                                        @click="loadExample('crm')"
                                        class="block w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                                    >
                                        <div class="font-medium text-gray-800">CRM System</div>
                                        <div class="text-sm text-gray-600">Customer relationship management with contacts, deals, and analytics</div>
                                    </button>
                                    <button 
                                        @click="loadExample('lms')"
                                        class="block w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                                    >
                                        <div class="font-medium text-gray-800">Learning Management System</div>
                                        <div class="text-sm text-gray-600">Online learning platform with courses, students, and assessments</div>
                                    </button>
                                    <button 
                                        @click="loadExample('helpdesk')"
                                        class="block w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                                    >
                                        <div class="font-medium text-gray-800">Helpdesk System</div>
                                        <div class="text-sm text-gray-600">Customer support with tickets, agents, and knowledge base</div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- DSL Input -->
                        <div v-if="inputMode === 'dsl'" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Specification DSL</label>
                                <textarea 
                                    v-model="dslSpec" 
                                    rows="12"
                                    placeholder="Enter specification in DSL format..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Import Input -->
                        <div v-if="inputMode === 'import'" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Import Type</label>
                                <select 
                                    v-model="importType"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                    <option value="openapi">OpenAPI/Swagger</option>
                                    <option value="csv">CSV Samples</option>
                                    <option value="erd">ERD JSON</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Import Data</label>
                                <textarea 
                                    v-model="importData" 
                                    rows="8"
                                    :placeholder="getImportPlaceholder()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Configuration -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Configuration</h3>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Max Iterations</label>
                                    <input 
                                        v-model.number="config.maxIterations" 
                                        type="number" 
                                        min="1" 
                                        max="10"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Token Budget</label>
                                    <input 
                                        v-model.number="config.tokenBudget" 
                                        type="number" 
                                        min="100000" 
                                        max="10000000"
                                        step="100000"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <label class="flex items-center">
                                    <input 
                                        v-model="config.requireApproval" 
                                        type="checkbox"
                                        class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    >
                                    <span class="ml-2 text-sm text-gray-700">Require Human Approval</span>
                                </label>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <button 
                                @click="startRun"
                                :disabled="!canStartRun || running"
                                class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                            >
                                <span v-if="running" class="flex items-center justify-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Running...
                                </span>
                                <span v-else>Start Meta-Builder Run</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Center Panel: Plan Preview -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Plan Preview</h2>
                        
                        <div v-if="!currentPlan" class="text-center py-8">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-600">No plan generated yet. Start a run to see the plan preview.</p>
                        </div>
                        
                        <div v-else class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h3 class="font-semibold text-blue-800 mb-2">Generated Specification</h3>
                                <div class="text-sm text-blue-700">
                                    <p><strong>Name:</strong> {{ currentPlan.name }}</p>
                                    <p><strong>Domain:</strong> {{ currentPlan.domain }}</p>
                                    <p><strong>Entities:</strong> {{ currentPlan.entities?.length || 0 }}</p>
                                    <p><strong>Acceptance Criteria:</strong> {{ currentPlan.acceptance?.length || 0 }}</p>
                                </div>
                            </div>
                            
                            <div v-if="currentPlan.entities" class="space-y-3">
                                <h4 class="font-medium text-gray-800">Entities</h4>
                                <div v-for="entity in currentPlan.entities" :key="entity.name" class="border border-gray-200 rounded-lg p-3">
                                    <h5 class="font-medium text-gray-800">{{ entity.name }}</h5>
                                    <div class="text-sm text-gray-600 mt-1">
                                        <div v-for="field in entity.fields" :key="field.name" class="flex justify-between">
                                            <span>{{ field.name }}</span>
                                            <span class="text-gray-500">{{ field.type }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Real-time Feedback -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Real-time Feedback</h2>
                        
                        <div v-if="!running && !currentRun" class="text-center py-8">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                            <p class="text-gray-600">Start a run to see real-time feedback and progress.</p>
                        </div>
                        
                        <div v-else class="space-y-4">
                            <!-- Run Status -->
                            <div v-if="currentRun" class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h3 class="font-semibold text-gray-800 mb-2">Run Status</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Status:</span>
                                        <span :class="getStatusClass(currentRun.status)" class="px-2 py-1 rounded-full text-xs font-medium">
                                            {{ currentRun.status }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Iteration:</span>
                                        <span class="text-sm font-medium">{{ currentRun.current_iteration }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Score:</span>
                                        <span class="text-sm font-medium">{{ currentRun.final_score || 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Agent Spans -->
                            <div v-if="agentSpans.length > 0" class="space-y-3">
                                <h4 class="font-medium text-gray-800">Agent Activity</h4>
                                <div v-for="span in agentSpans" :key="span.id" class="border border-gray-200 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-medium text-sm">{{ span.agent_role }}</span>
                                        <span :class="span.success ? 'text-green-600' : 'text-red-600'" class="text-xs">
                                            {{ span.success ? '✓' : '✗' }}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-600">{{ span.span_name }}</div>
                                    <div class="text-xs text-gray-500 mt-1">{{ span.duration_ms }}ms</div>
                                </div>
                            </div>
                            
                            <!-- Failures & Fixes -->
                            <div v-if="failures.length > 0" class="space-y-3">
                                <h4 class="font-medium text-gray-800">Issues & Fixes</h4>
                                <div v-for="failure in failures" :key="failure.id" class="border border-red-200 rounded-lg p-3 bg-red-50">
                                    <div class="font-medium text-red-800 text-sm">{{ failure.title }}</div>
                                    <div class="text-xs text-red-600 mt-1">{{ failure.description }}</div>
                                    <div v-if="failure.fix" class="text-xs text-green-600 mt-2">
                                        <strong>Fix:</strong> {{ failure.fix }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    inputMode: 'natural',
                    projectName: '',
                    goalText: '',
                    dslSpec: '',
                    importType: 'openapi',
                    importData: '',
                    config: {
                        maxIterations: 4,
                        tokenBudget: 2000000,
                        requireApproval: true
                    },
                    running: false,
                    currentRun: null,
                    currentPlan: null,
                    agentSpans: [],
                    failures: [],
                    examples: {
                        crm: {
                            name: 'My CRM System',
                            goal: 'Build a customer relationship management system with contact management, deal pipeline, and analytics. Include user authentication, role-based access control, and integration with email and calendar systems.'
                        },
                        lms: {
                            name: 'Learning Management System',
                            goal: 'Create a learning management system for online education. Include course management, student enrollment, progress tracking, assessments, and certificate generation. Support multiple instructors and course categories.'
                        },
                        helpdesk: {
                            name: 'Customer Support Helpdesk',
                            goal: 'Build a customer support helpdesk system with ticket management, agent assignment, knowledge base, and customer portal. Include SLA tracking, automated responses, and reporting capabilities.'
                        }
                    }
                }
            },
            computed: {
                canStartRun() {
                    if (this.inputMode === 'natural') {
                        return this.projectName && this.goalText;
                    } else if (this.inputMode === 'dsl') {
                        return this.dslSpec;
                    } else if (this.inputMode === 'import') {
                        return this.importData;
                    }
                    return false;
                }
            },
            methods: {
                loadExample(type) {
                    const example = this.examples[type];
                    if (example) {
                        this.projectName = example.name;
                        this.goalText = example.goal;
                    }
                },
                getImportPlaceholder() {
                    const placeholders = {
                        openapi: 'Paste your OpenAPI/Swagger JSON here...',
                        csv: 'Paste your CSV data here...',
                        erd: 'Paste your ERD JSON here...'
                    };
                    return placeholders[this.importType] || '';
                },
                async startRun() {
                    this.running = true;
                    this.currentRun = null;
                    this.currentPlan = null;
                    this.agentSpans = [];
                    this.failures = [];
                    
                    try {
                        const payload = {
                            name: this.projectName,
                            goal_text: this.goalText,
                            limits: {
                                max_iters: this.config.maxIterations,
                                token_budget: this.config.tokenBudget,
                                timeout_s: 900
                            },
                            review: {
                                require_approval: this.config.requireApproval
                            }
                        };
                        
                        if (this.inputMode === 'import') {
                            payload.inputs = {
                                [this.importType]: JSON.parse(this.importData)
                            };
                        }
                        
                        const response = await axios.post('/api/meta/v2/build/run', payload);
                        this.currentRun = response.data.data.attributes;
                        
                        // Start polling for updates
                        this.pollRunStatus();
                        
                    } catch (error) {
                        console.error('Failed to start run:', error);
                        this.failures.push({
                            id: Date.now(),
                            title: 'Run Failed',
                            description: error.response?.data?.errors?.[0]?.detail || 'Unknown error'
                        });
                    } finally {
                        this.running = false;
                    }
                },
                async pollRunStatus() {
                    if (!this.currentRun) return;
                    
                    try {
                        const response = await axios.get(`/api/meta/v2/build/${this.currentRun.id}`);
                        const data = response.data.data;
                        
                        this.currentRun = data.attributes;
                        this.agentSpans = data.relationships.spans.data;
                        
                        // Check for completed status
                        if (['completed', 'failed', 'cancelled'].includes(this.currentRun.status)) {
                            return;
                        }
                        
                        // Continue polling
                        setTimeout(() => this.pollRunStatus(), 2000);
                        
                    } catch (error) {
                        console.error('Failed to poll run status:', error);
                    }
                },
                getStatusClass(status) {
                    const classes = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'planning': 'bg-blue-100 text-blue-800',
                        'generating': 'bg-purple-100 text-purple-800',
                        'evaluating': 'bg-indigo-100 text-indigo-800',
                        'fixing': 'bg-orange-100 text-orange-800',
                        'approval_required': 'bg-red-100 text-red-800',
                        'approved': 'bg-green-100 text-green-800',
                        'rejected': 'bg-red-100 text-red-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'cancelled': 'bg-gray-100 text-gray-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
